<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zgj.mps.dao.mapper.DownloadMapper">
    <resultMap id="BaseResultMap" type="com.zgj.mps.bean.DownloadBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="status" jdbcType="SMALLINT" property="status"/>
        <result column="size" jdbcType="SMALLINT" property="size"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="finishTime" jdbcType="TIMESTAMP" property="finishTime"/>
        <result column="user_id" jdbcType="VARCHAR" property="userId"/>
        <result column="resource_id" jdbcType="VARCHAR" property="resourceId"/>
        <result column="account" jdbcType="VARCHAR" property="account"/>
        <result column="resourceName" jdbcType="VARCHAR" property="resourceName"/>
        <result column="avatar" jdbcType="VARCHAR" property="avatar"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="pro_img" jdbcType="VARCHAR" property="resourceProImg"/>
    </resultMap>
    <resultMap id="StatusResultMap" type="com.zgj.mps.bean.DownStatusBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="create_time" jdbcType="INTEGER" property="createTime"/>
        <result column="finishTime" jdbcType="TIMESTAMP" property="finishTime"/>
        <result column="resourceName" jdbcType="VARCHAR" property="resourceName"/>
        <result column="resource_id" jdbcType="VARCHAR" property="resourceId"/>
        <result column="status" jdbcType="SMALLINT" property="status"/>
    </resultMap>
    <resultMap id="DownResourceResultMap" type="com.zgj.mps.bean.DownResourceBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="status" jdbcType="SMALLINT" property="status"/>
        <result column="resourceName" jdbcType="VARCHAR" property="resourceName"/>
        <result column="url" jdbcType="VARCHAR" property="url"/>
    </resultMap>
    <resultMap id="DwonTopResultMap" type="com.zgj.mps.bean.DownloadTopBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="total" jdbcType="INTEGER" property="total"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
    </resultMap>
    <select id="pageDownload" parameterType="com.zgj.mps.bean.DownloadBean" resultMap="BaseResultMap">
        SELECT d.id,d.status,d.create_time,d.finish_time,d.user_id,d.resource_id,t.account,t.name,t.avatar,r.name as resourceName,r.pro_img,r.size
        from download d,user t,resource r
        where d.user_id=t.id and d.resource_id=r.id
        and d.is_delete=0 and r.is_delete=0
        <if test="downloadBean.resourceName!=null and downloadBean.resourceName!=''">
            and r.name like CONCAT('%',#{downloadBean.resourceName},'%')
        </if>
        <if test="downloadBean.account!=null and downloadBean.account!=''">
            and t.account like CONCAT('%',#{downloadBean.account},'%')
        </if>
        <if test="downloadBean.name!=null and downloadBean.name!=''">
            and t.name like CONCAT('%',#{downloadBean.name},'%')
        </if>
        and d.status=#{downloadBean.status}
        order by d.create_time desc
    </select>
    <select id="downProcessByDevictType" parameterType="java.lang.String" resultMap="StatusResultMap">
        SELECT dw.*,r.name as resourceName from download dw,resource r,device_resource dr ,device d,device_type dt
        where dw.resource_id=r.id
        and r.id = dr.resource_id
        and dr.device_id=d.id
        and d.device_type_id=dt.id
        and dw.is_delete=0
        and r.is_delete=0
        and dt.`name`=#{type};
    </select>
    <select id="userDownList" parameterType="java.lang.String" resultMap="DownResourceResultMap">
        SELECT t.id,t.status, r.name as resourceName,r.url FROM download t LEFT JOIN resource r on t.resource_id=r.id
        and t.user_id=#{userId}
        and t.device_mac=#{deviceMac}
    </select>
    <select id="downloadTop10" resultMap="DwonTopResultMap">
        SELECT o.*,r.name FROM(
          SELECT COUNT(id) as total, t.resource_id FROM download t  GROUP BY resource_id ORDER BY total desc LIMIT 0,10) o LEFT JOIN resource r on o.resource_id=r.id
    </select>
    <select id="getMonthDownload" resultType="java.util.HashMap" parameterType="java.lang.Integer">
        SELECT
        SUM(
            CASE MONTH (create_time)
            WHEN '1' THEN
                1
            ELSE
                0
            END
        ) AS '1',
        SUM(
            CASE MONTH (create_time)
            WHEN '2' THEN
                1
            ELSE
                0
            END
        ) AS '2',
        SUM(
            CASE MONTH (create_time)
            WHEN '3' THEN
                1
            ELSE
                0
            END
        ) AS '3',
        SUM(
            CASE MONTH (create_time)
            WHEN '4' THEN
                1
            ELSE
                0
            END
        ) AS '4',
        SUM(
            CASE MONTH (create_time)
            WHEN '5' THEN
                1
            ELSE
                0
            END
        ) AS '5',
        SUM(
            CASE MONTH (create_time)
            WHEN '6' THEN
                1
            ELSE
                0
            END
        ) AS '6',
        SUM(
            CASE MONTH (create_time)
            WHEN '7' THEN
                1
            ELSE
                0
            END
        ) AS '7',
        SUM(
            CASE MONTH (create_time)
            WHEN '8' THEN
                1
            ELSE
                0
            END
        ) AS '8',
        SUM(
            CASE MONTH (create_time)
            WHEN '9' THEN
                1
            ELSE
                0
            END
        ) AS '9',
        SUM(
            CASE MONTH (create_time)
            WHEN '10' THEN
                1
            ELSE
                0
            END
        ) AS '10',
        SUM(
            CASE MONTH (create_time)
            WHEN '11' THEN
                1
            ELSE
                0
            END
        ) AS '11',
        SUM(
            CASE MONTH (create_time)
            WHEN '12' THEN
                1
            ELSE
                0
            END
        ) AS '12'
    FROM
        download
    WHERE
    YEAR (create_time) =#{year}
    </select>
</mapper>