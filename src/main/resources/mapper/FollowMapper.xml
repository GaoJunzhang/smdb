<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zgj.mps.dao.mapper.FollowMapper">
    <resultMap id="BaseResultMap" type="com.zgj.mps.bean.FollowBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="user_id" jdbcType="VARCHAR" property="userId"/>
        <result column="resource_id" jdbcType="VARCHAR" property="resourceId"/>
        <result column="resourceName" jdbcType="VARCHAR" property="resourceName"/>
        <result column="account" jdbcType="VARCHAR" property="account"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
    </resultMap>
    <resultMap id="FollowResourceResultMap" type="com.zgj.mps.bean.FollowResourceBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="resourceName" jdbcType="VARCHAR" property="resourceName"/>
        <result column="url" jdbcType="VARCHAR" property="url"/>
    </resultMap>
    <resultMap id="DwonTopResultMap" type="com.zgj.mps.bean.DownloadTopBean">
        <result column="id" jdbcType="VARCHAR" property="id"/>
        <result column="total" jdbcType="INTEGER" property="total"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
    </resultMap>
    <select id="pageFollow" parameterType="com.zgj.mps.bean.FollowBean" resultMap="BaseResultMap">
        SELECT f.id,f.create_time,f.user_id,f.resource_id,t.account,t.name,t.avatar,r.name as resourceName
        from follow f,user t,resource r
        where f.user_id=t.id and f.resource_id=r.id
        and r.is_delete=0
        <if test="followBean.resourceName!=null and followBean.resourceName!=''">
            and r.name like CONCAT('%',#{followBean.resourceName},'%')
        </if>
        <if test="followBean.account!=null and followBean.account!=''">
            and t.account like CONCAT('%',#{followBean.account},'%')
        </if>
        <if test="followBean.name!=null and followBean.name!=''">
            and t.name like CONCAT('%',#{followBean.name},'%')
        </if>
        resourceOrder by d.create_time desc
    </select>
    <select id="userFollowList" parameterType="java.lang.Long" resultMap="FollowResourceResultMap">
        SELECT t.id,r.name as resourceName,r.url FROM follow t LEFT JOIN resource r on t.resource_id=r.id
        and t.user_id=#{userId}
    </select>
    <select id="getMonthDownload" resultType="java.util.HashMap" parameterType="java.lang.Integer">
        SELECT
        SUM(
            CASE MONTH (create_time)
            WHEN '1' THEN
                1
            ELSE
                0
            END
        ) AS '1',
        SUM(
            CASE MONTH (create_time)
            WHEN '2' THEN
                1
            ELSE
                0
            END
        ) AS '2',
        SUM(
            CASE MONTH (create_time)
            WHEN '3' THEN
                1
            ELSE
                0
            END
        ) AS '3',
        SUM(
            CASE MONTH (create_time)
            WHEN '4' THEN
                1
            ELSE
                0
            END
        ) AS '4',
        SUM(
            CASE MONTH (create_time)
            WHEN '5' THEN
                1
            ELSE
                0
            END
        ) AS '5',
        SUM(
            CASE MONTH (create_time)
            WHEN '6' THEN
                1
            ELSE
                0
            END
        ) AS '6',
        SUM(
            CASE MONTH (create_time)
            WHEN '7' THEN
                1
            ELSE
                0
            END
        ) AS '7',
        SUM(
            CASE MONTH (create_time)
            WHEN '8' THEN
                1
            ELSE
                0
            END
        ) AS '8',
        SUM(
            CASE MONTH (create_time)
            WHEN '9' THEN
                1
            ELSE
                0
            END
        ) AS '9',
        SUM(
            CASE MONTH (create_time)
            WHEN '10' THEN
                1
            ELSE
                0
            END
        ) AS '10',
        SUM(
            CASE MONTH (create_time)
            WHEN '11' THEN
                1
            ELSE
                0
            END
        ) AS '11',
        SUM(
            CASE MONTH (create_time)
            WHEN '12' THEN
                1
            ELSE
                0
            END
        ) AS '12'
    FROM
        follow
    WHERE
    YEAR (create_time) =#{year}
    </select>
    <select id="downloadTop10" resultMap="DwonTopResultMap">
        SELECT o.*,r.name FROM(
          SELECT COUNT(id) as total, t.resource_id FROM follow t  GROUP BY resource_id ORDER BY total desc LIMIT 0,10) o LEFT JOIN resource r on o.resource_id=r.id
    </select>
</mapper>